{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Viewport-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <!-- SEO Meta Tags-->
    <meta name="keywords" content="quicky, chat, messenger, conversation, social, communication" />
    <meta name="description" content="저희는 kt aivle school 빅프로젝트~~~~~~~~~~~~~~~~~~~~" />
    <meta name="subject" content="communication">
    <meta name="copyright" content="frontendmatters">
     <meta name="revised" content="Tuesday, November 10th, 2020, 08:00 am" />
    <title>Consult chat</title>
    <!-- Favicon and Touch Icons-->
    <link rel="apple-touch-icon" sizes="180x180" href='{% static "/consult/workerschat/apple-touch-icon.png" %}'> 
    <link rel="icon" type="image/png" sizes="32x32" href='{% static "/consult/workerschat/favicon-32x32.png" %}'>
    <link rel="icon" type="image/png" sizes="16x16" href='{% static "/consult/workerschat/favicon-16x16.png" %}'>
    <link rel="shortcut icon" href='{% static "/consult/workerschat/favicon.ico" %}' />
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" href='{% static "webfonts/inter/inter.css" %}'> 
    <link rel="stylesheet" href='{% static "css/app.min.css" %}'>


</head>

<body class="chats-tab-open">

    <!-- Main Layout Start -->
    <div class="main-layout">
        <!-- Navigation Start -->
        <div class="navigation navbar navbar-light bg-primary">
            <!-- Logo Start -->
            <a class="d-none d-xl-block bg-light rounded p-1" href='/'>
                <!-- Default :: Inline SVG -->
                <svg height="30" width="30" viewBox="0 0 512 511" ><g><path d="m120.65625 512.476562c-7.25 0-14.445312-2.023437-20.761719-6.007812-10.929687-6.902344-17.703125-18.734375-18.117187-31.660156l-1.261719-41.390625c-51.90625-46.542969-80.515625-111.890625-80.515625-183.992188 0-68.816406 26.378906-132.101562 74.269531-178.199219 47.390625-45.609374 111.929688-70.726562 181.730469-70.726562s134.339844 25.117188 181.730469 70.726562c47.890625 46.097657 74.269531 109.382813 74.269531 178.199219 0 68.8125-26.378906 132.097657-74.269531 178.195313-47.390625 45.609375-111.929688 70.730468-181.730469 70.730468-25.164062 0-49.789062-3.253906-73.195312-9.667968l-46.464844 20.5c-5.035156 2.207031-10.371094 3.292968-15.683594 3.292968zm135.34375-471.976562c-123.140625 0-216 89.816406-216 208.925781 0 60.667969 23.957031 115.511719 67.457031 154.425781 8.023438 7.226563 12.628907 17.015626 13.015625 27.609376l.003906.125 1.234376 40.332031 45.300781-19.988281c8.15625-3.589844 17.355469-4.28125 25.921875-1.945313 20.132812 5.554687 41.332031 8.363281 63.066406 8.363281 123.140625 0 216-89.816406 216-208.921875 0-119.109375-92.859375-208.925781-216-208.925781zm-125.863281 290.628906 74.746093-57.628906c5.050782-3.789062 12.003907-3.839844 17.101563-.046875l55.308594 42.992187c16.578125 12.371094 40.304687 8.007813 51.355469-9.433593l69.519531-110.242188c6.714843-10.523437-6.335938-22.417969-16.292969-14.882812l-74.710938 56.613281c-5.050781 3.792969-12.003906 3.839844-17.101562.046875l-55.308594-41.988281c-16.578125-12.371094-40.304687-8.011719-51.355468 9.429687l-69.554688 110.253907c-6.714844 10.523437 6.335938 22.421874 16.292969 14.886718zm0 0" data-original="#000000" class="active-path" data-old_color="#000000" fill="#665dfe"/></g> </svg>
            </a>
            <!-- Logo End -->

            <!-- Main Nav Start -->
            <ul class="nav nav-minimal flex-row flex-grow-1 justify-content-between flex-xl-column justify-content-xl-center" id="mainNavTab" role="tablist">
             

            </ul>
            <!-- Main Nav End -->
        </div>
        <!-- Navigation End -->

        <!-- Sidebar Start -->
        <aside class="sidebar">
            <!-- Tab Content Start -->
            <div class="tab-content">
                <!-- Chat Tab Content Start -->
                <div class="tab-pane active" id="chats-content">
                    <div class="d-flex flex-column h-100">
                        <div class="hide-scrollbar h-100" id="chatContactsList">
                            
                            <!-- Chat Header Start -->
                            <div class="sidebar-header sticky-top p-2">

                                <div class="d-flex justify-content-between align-items-center">
                                    <!-- Chat Tab Pane Title Start -->
                                    {% if request.user.member_type == 'Counselor' %}
                                        <h5 class="font-weight-semibold mb-0">상담 목록</h5>
                                    {% elif request.user.member_type == 'Customer' %}
                                        <h5 class="font-weight-semibold mb-0">FAQ</h5>
                                    {% endif %}
                                    
                                    <!-- Chat Tab Pane Title End -->
                                    <ul class="nav flex-nowrap">
                                        <li class="nav-item list-inline-item d-block d-xl-none mr-1">
                                            <a class="nav-link text-muted px-1" href="#" title="Appbar" data-toggle-appbar="">
                                                <!-- Default :: Inline SVG -->
                                                <svg class="hw-20" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                                <!-- Sidebar Header End -->

                            </div>
                            <!-- Chat Header End -->

                            <!-- Chat Contact List Start -->
                            <ul class="contacts-list" id="chatContactTab" data-chat-list="">
                                <!-- Chat Item Start -->

                                <!-- user가 Counselor 경우, 고객 상담 이력 보이도록 -->
                                {% if request.user.member_type == 'Counselor' %}

                                    <!-- 고객 정보 모두 출력(임시) -->
                                    <!--
                                    {% for c in customers %}
                                        <li class="contacts-item friends">
                                            <div class="avatar d-none d-sm-inline-block mr-3 {% if c.chat_active %}avatar-online{% else %}avatar-offline{% endif %}">
                                                <img class="avatar-img" {% if c.image %}src={{ c.image.url }}{% else %}src="{% static 'images/user_default_image.png' %}" {% endif %} alt="">
                                            </div>
                                            <div class="contacts-content">
                                                <div class="contacts-info">
                                                    <h6 class="chat-name text-truncate">{{ c.username }}</h6>
                                                    <div class="chat-time">{{ c.nation }}</div>
                                                </div>
                                                <div class="contacts-texts">
                                                    <p class="text-truncate">{{ c.phone_number }}</p>
                                                </div>
                                            </div>
                                        </li>

                                        {% for call in calls %}
                                            {% if call.customer_id == c.id %}
                                                <li class="contacts-item friends">
                                                    <div class="contacts-content">
                                                        <div class="contacts-info">
                                                            <h6 class="chat-name text-truncate">{{ call.title }}</h6>
                                                            <div class="chat-time">Call({{ call.counselor.username }})</div>
                                                        </div>
                                                        <div class="contacts-texts">
                                                            <p class="text-truncate">{{ call.summary }}</p>
                                                        </div>
                                                        <div class="contacts-texts">
                                                            <p class="text-truncate">{{ call.consult_date }}</p>
                                                        </div>
                                                    </div>
                                                </li>
                                            {% endif %}
                                        {% endfor %}

                                    {% endfor %}
                                    -->

                                    <!-- cutomser 정보 없을 경우 -->
                                    {% if customer is None %}
                                        <li class="contacts-item friends">
                                            <div class="contacts-texts">
                                                <p class="text-truncate">상담 목록이 존재하지 않습니다.</p>
                                            </div>
                                        </li>
                                    
                                    <!-- customer 정보 있을 경우, 상담 이력 출력 -->
                                    {% else %}
                                        {% for call in calls %}
                                            {% if call.customer_id == customer.id %}
                                                <li class="contacts-item friends">
                                                    <div class="contacts-content">
                                                        <div class="contacts-info">
                                                            <h6 class="chat-name text-truncate">{{ call.title }}</h6>
                                                            <div class="chat-time">Call({{ call.counselor.username }})</div>
                                                        </div>
                                                        <div class="contacts-texts">
                                                            <p class="text-truncate">{{ call.summary }}</p>
                                                        </div>
                                                        <div class="contacts-texts">
                                                            <p class="text-truncate">{{ call.consult_date }}</p>
                                                        </div>
                                                    </div>
                                                </li>
                                            {% endif %}
                                        {% endfor %} 
                                    {% endif %}

                                <!-- user가 Customer일 경우, FAQ 보이게 -->
                                {% elif request.user.member_type == 'Customer' %}
                                    {% comment %} {% for faq in faqs %}
                                        <li class="contacts-item friends">
                                            <div class="contacts-content">
                                                <div class="contacts-info">
                                                    <h6 class="chat-name text-truncate">{{ faq.title }}</h6>
                                                </div>
                                                <div class="contacts-texts">
                                                    <p class="text-truncate">{{ faq.detail|safe }}</p>
                                                </div>
                                            </div>
                                        </li>
                                    {% endfor %} {% endcomment %}
                                    <ul class="accordion">
                                        {% for faq in faqs %}
                                            <li class="accordion-item">
                                                <label class="accordion-title">{{ faq.title }}</label>
                                                <div class="accordion-content">
                                                    <p>{{ faq.detail|safe }}</p>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                                                         
                                {% endif %}
                            </ul>
                            <!-- Chat Contact List End -->

                        </div>
                    </div>
                </div>
            </div>
            <!-- Tab Content End -->
        </aside>
        <!-- Sidebar End -->

        <!-- Main Start -->
        <main class="main main-visible">

            <!-- Chats Page Start -->
            <div class="chats">
                <div class="chat-body">

                    <!-- Chat Header Start-->
                    <div class="chat-header">
                        <!-- Chat Back Button (Visible only in Small Devices) -->
                        <button class="btn btn-secondary btn-icon btn-minimal btn-sm text-muted d-xl-none" type="button" data-close="">
                            <!-- Default :: Inline SVG -->
                            <svg class="hw-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                        </button>

                        <!-- Chat participant's Name -->
                        <!-- Counselor인 경우, Customer 정보 보이도록-->
                        {% if request.user.member_type == 'Counselor' %}
                            <!-- customer 정보가 없을 경우 -->
                            {% if customer is None %}
                                <div class="media chat-name align-items-center text-truncate">
                                    <div class="avatar d-none d-sm-inline-block mr-3 avatar-offline">
                                        <img class="avatar-img" src="{% static 'images/user_default_image.png' %}" alt="">
                                    </div>

                                    <div class="media-body align-self-center ">
                                        <h6 class="text-truncate mb-0">상대 없음</h6>
                                        <small class="text-muted">오프라인</small>
                                    </div>
                                </div>

                            <!-- customer 정보가 있을 경우, customer 정보 출력 -->
                            {% else%}
                                <div class="media chat-name align-items-center text-truncate">
                                    <div class="avatar d-none d-sm-inline-block mr-3 {% if customer.chat_active %}avatar-online{% else %}avatar-offline{% endif %}" id="customer-img-div">
                                        <img class="avatar-img" {% if customer.image %}src={{ customer.image.url }}{% else %}src="{% static 'images/user_default_image.png' %}" {% endif %} alt="" id="customer-img">
                                    </div>

                                    <div class="media-body align-self-center ">
                                        <h6 class="text-truncate mb-0" id="customer-info-name">{{ customer.username }}</h6>
                                        <small class="text-muted" id="customer-info-active">{% if customer.chat_active %}온라인{% else %}오프라인{% endif %}</small>
                                    </div>
                                </div>
                            {% endif %}

                        <!-- Customer인 경우, Counselor 정보 보이도록 -->
                        {% elif request.user.member_type == 'Customer' %}
                            <div class="media chat-name align-items-center text-truncate">
                                <div class="avatar d-none d-sm-inline-block mr-3 {% if counselor.voice_active %}avatar-online{% else %}avatar-offline{% endif %}">
                                    <img class="avatar-img" {% if counselor.image %}src={{ counselor.image.url }}{% else %}src="{% static 'images/user_default_image.png' %}" {% endif %} alt="">
                                </div>

                                <div class="media-body align-self-center ">
                                    <h6 class="text-truncate mb-0">{{ counselor.username }}</h6>
                                    <small class="text-muted">{% if counselor.voice_active %}온라인{% else %}오프라인{% endif %}</small>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <!-- Chat Header End-->

                    <!-- Search Start -->
                    <div class="collapse border-bottom px-3" id="searchCollapse">
                        <div class="container-xl py-2 px-0 px-md-3">
                            <div class="input-group bg-light ">
                                <input type="text" class="form-control form-control-md border-right-0 transparent-bg pr-0" placeholder="Search">
                                <div class="input-group-append">
                                    <span class="input-group-text transparent-bg border-left-0">
                                        <!-- Default :: Inline SVG -->
                                        <svg class="hw-20 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                        </svg>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                    </div>

                    {% if request.user.member_type == 'Counselor' %}
                        <!-- 상담사인 경우, 사용 언어 한국어 default -->
                        <label for="language">STT, TTS 언어 선택:</label>
                        <select id="language" style="text-align:center; width: 300px; height: 30px; font-size: 18px; border-radius:5px;">
                            <option value="ko">한국어</option>
                            <option value="en-US" disabled>English</option>
                            <option value="ja-JP" disabled>日本語</option>
                            <option value="zh-CN" disabled>中文</option>
                            <option value="th-TH" disabled>ภาษาไทย</option>
                            <option value="vi-VN" disabled>Tiếng Việt</option>
                            <!-- 다른 언어 옵션 추가 가능 -->
                        </select>

                        <!-- 상담사인 경우, 고객 사용 언어에 맞게 설정 -->
                        <div class="container" style="display: flex; align-items:center; margin-top:10px;">
                            <label for="translation-language" class="label" style="font-size:18px;"> Language :</label>
                            <select id="translation-language" class="select-box" style="margin-left: 10px; text-align:center; width: 200px; height: 30px; font-size: 18px; border-radius:5px;">
                                <option value="ko">한국어</option>
                                <option value="en">English</option>
                                <option value="ja">日本語</option>
                                <option value="zh-CN">中文</option>
                                <option value="th-TH">ภาษาไทย</option>
                                <option value="vi-VN">Tiếng Việt</option>
                                <!-- 다른 언어 옵션 추가 가능 -->
                            </select>
                        </div>
                    {% elif request.user.member_type == 'Customer' %}
                        <!-- 고객인 경우, 사용 언어 설정 -->
                        
                        <div class="container" style="display: flex; align-items:center; margin-top:10px;">
                            <label for="language" class="label" style="font-size:18px;">Language :</label>
                            <select id="language" class="select-box" style="margin-left: 10px; text-align:center; width: 200px; height: 30px; font-size: 18px; border-radius:5px;">
                                <option value="ko">한국어</option>
                                <option value="en-US">English</option>
                                <option value="ja-JP">日本語</option>
                                <option value="zh-CN">中文</option>
                                <option value="th-TH">ภาษาไทย</option>
                                <option value="vi-VN">Tiếng Việt</option>
                                <!-- 다른 언어 옵션 추가 가능 -->
                            </select>
                        </div>
                        
                        <!-- 고객인 경우, 번역 언어 한국어 default -->
                        <label for="translation-language"> Translation 언어 선택:(고객은 한국어 default, 상담원은 고객 국적에 맞게 설정)</label>
                        <select id="translation-language" style="text-align:center; width: 300px; height: 30px; font-size: 18px; border-radius:5px;">
                            <option value="ko">한국어</option>
                            <option value="en" disabled>English</option>
                            <option value="ja" disabled>日本語</option>
                            <option value="zh-CN" disabled>中文</option>
                            <option value="th-TH" disabled>ภาษาไทย</option>
                            <option value="vi-VN" disabled>Tiếng Việt</option>
                            <!-- 다른 언어 옵션 추가 가능 -->
                        </select>
                    {% endif %}

                    <div class="chat-content p-2" id="messageBody">
						<div class="container" id="chat-log">
							<!-- 채팅 로그가 표시될 영역 -->
                        </div> 
						
						<!-- Scroll to finish -->
						<div class="chat-finished" id="chat-finished"></div>
					</div>
                    <p id="message" style="text-align: center;">버튼을 누르고 아무 말이나 하세요.</p>

                    <div class="textWrapper" style="text-align: center; margin-top: -10px; margin-bottom: 10px; font-weight:bold;">
                        <div id="japanese" class="textbox"></div>
                        <div id="korean" class="textbox"></div>
                    </div>

					
                    <div id="message" ></div>
                    <div class="button-container" style="display: flex; justify-content: center; margin-bottom: 40px;">
                        <button class="btn btn-outline-primary" id="speech" onclick="startSTT()">Start STT</button>
                        <button class="btn btn-outline-primary" id="stop" onclick="stopSTT()" style="margin-left:20px;" disabled>Stop STT</button>
                    </div>

                    <!-- tts api key, region값 받아오려고 설정한 거 -->
                    <p id="tts-key" style="display:none;">{{ key }}</p>
                    <p id="tts-region" style="display:none;">{{ region }}</p>
                    
                    <!-- 상담 종료 버튼 -->
                    <div class="btn">
                        <a {% if request.user.member_type == 'Customer' %}href="{% url 'survey:submit' %}"
                        {% elif request.user.member_type == 'Counselor' %}href="{% url 'voicechat:voicechat_end' %}"{% endif %}
                        class="btn btn-primary"
                        style="position: fixed;
                        bottom: 3.5rem;
                        right: 5rem;
                        z-index: 999999;
                        box-shadow: 0 1px 20px 1px #696cff;"
                        >상담 종료</a>
                    </div>

                </div>
            </div>
        </main>
        <!-- Main End -->

        <!-- App Add-ons Start -->
        <div class="appbar">
            <div class="appbar-wrapper hide-scrollbar">

                <!-- Chat Back Button (Visible only in Small Devices) -->
                <div class="d-flex justify-content-center border-bottom w-100">
                    <button class="btn btn-secondary btn-icon m-0 btn-minimal btn-sm text-muted d-xl-none" type="button" data-apps-close="">
                        <!-- Default :: Inline SVG -->
                        <svg class="hw-20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
    
                        <!-- Alternate :: External File link -->
                        <!-- <img class="injectable hw-20" src="./../assets/media/heroicons/outline/arrow-left.svg" alt=""> -->
                    </button>
                </div>


                
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!-- App Add-ons End -->

        <div class="backdrop"></div>

    </div>
    <!-- Main Layout End -->
	{{ room_name|json_script:"room-name" }}
	{{ user.username|json_script:"username" }}
	{{ user.id|json_script:"user_id" }}

    <!-- Javascript Files -->
    <script src='{% static "vendors/jquery/jquery-3.5.0.min.js" %}'></script>
    <script src='{% static "vendors/bootstrap/bootstrap.bundle.min.js" %}'></script>
    <script src='{% static "vendors/magnific-popup/jquery.magnific-popup.js" %}'></script>
    <script src='{% static "vendors/svg-inject/svg-inject.js" %}'></script>
    <script src='{% static "vendors/modal-stepes/modal-steps.min.js" %}'></script>
    <script src='{% static "/consult/workerschat/static/vendors/emojione/emojionearea.min.js" %}'></script>
    <script src='{% static "js/app.min.js" %}'></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // Scroll to end of chat
        document.querySelector('.chat-finished').scrollIntoView({
            block: 'end',               // "start" | "center" | "end" | "nearest",
            behavior: 'auto'          //"auto"  | "instant" | "smooth",
        });

    </script>

    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        const username = JSON.parse(document.getElementById('username').textContent);
        const user_id = JSON.parse(document.getElementById('user_id').textContent);

        const VoicechatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/voicechat/' + roomName.replace(/"/g, '') + '/'
        );

        VoicechatSocket.onopen = function (e) {
            fetchMessages();
        };

        VoicechatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            
            if (data['command'] === 'messages') {
              for (let i = 0; i < data['messages'].length; i++) {
                createMessage(data['messages'][i]);
                if (message.user != username){
                    const messageText = JSON.stringify(data['messages'][1]);
                    textToSpeech(messageText, 'ko'); // 메시지 도착 시 TTS 실행
                }
              }
            } else if (data['command'] === 'new_message') {
              createMessage(data['message']);
              const message = data['message'];
              if (message.user != username){
                const messageText = `${message.content}`;
                textToSpeech(messageText, 'ko'); // 메시지 도착 시 TTS 실행
              }
            }
          };
          VoicechatSocket.onclose = function (e) {
            console.error('Chat socket closed unexpectedly');
          };

        document.querySelector('#chat-message-submit').onclick = function (e) {
            const messageInputDom = document.querySelector('#korean');
            const message = messageInputDom.textContent;
            VoicechatSocket.send(
                JSON.stringify({
                    message: message,
                    user: username,
                    user_id: user_id,
                    command: 'new_message'
                })
            );
            messageInputDom.textContent = '';
        };

        function fetchMessages() {
            VoicechatSocket.send(
            JSON.stringify({
            command: 'fetch_messages',
            from: username
            }),
        );
        }

        function scrollToBottom() {
        const chatContent = document.querySelector('#messageBody');
        chatContent.scrollTop = chatContent.scrollHeight;
        }
        
    </script>

    
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>

    <script>
        var message = document.querySelector('#message');
        var speechButton = document.querySelector('#speech');
        var stopButton = document.querySelector('#stop');
        var languageSelect = document.querySelector('#language');
        var translationLanguage = document.querySelector("#translation-language");
        var japanese = document.querySelector('#japanese');
        var korean = document.querySelector('#korean');
        var isRecognizing = false;

        var localStream;
        var remoteStream;
        var localPeerConnection;
        var remotePeerConnection;

        var servers = {
        iceServers: [
            {
            urls: 'stun:stun.l.google.com:19302'
            }
        ]
        };

        var mediaStreamConstraints = {
                audio: true,
                video: false
        };

        var recognition; // 음성 인식 객체

        function startSTT() {
        recognition = new (window.SpeechRecognition ||
            window.webkitSpeechRecognition ||
            window.mozSpeechRecognition ||
            window.msSpeechRecognition)();
        var selectedLanguage = languageSelect.value;
        recognition.lang = selectedLanguage;
        recognition.interimResults = false;
        recognition.maxAlternatives = 5;

        recognition.onstart = function () {
            console.log('Enter your voice');
            message.innerHTML = 'Speech recognition...';
            speechButton.innerHTML = 'Listening...';
            speechButton.disabled = true;
        };

        recognition.onspeechend = function () {
            message.innerHTML = 'Enter your voice';
            speechButton.disabled = false;
            speechButton.innerHTML = 'Start STT';
        };

        recognition.onresult = function (event) {
            console.log('You said:', event.results[0][0].transcript);
            var resText = event.results[0][0].transcript;
            japanese.innerHTML = resText;
            translate(resText);
        };

        recognition.onend = function () {
            message.innerHTML = 'Enter your voice';
            speechButton.disabled = false;
            speechButton.innerHTML = 'Start STT';
            isRecognizing = false;
        };

        recognition.start();
        isRecognizing = true;
        }

        function stopSTT() {
        recognition.stop();
        message.innerHTML = 'Enter your voice';
        speechButton.disabled = false;
        speechButton.innerHTML = 'Start STT';
        isRecognizing = false;
        }

        function translate(text) {
        var apiKey = 'AIzaSyAaQGwWd7MTIe5tCeeikiXzwXxLIKxI09M';
        var url = 'https://translation.googleapis.com/language/translate/v2';
        var selectedTranslationLanguage = translationLanguage.value;
        var targetLang = selectedTranslationLanguage;

        $.ajax({
            url: url,
            method: "POST",
            dataType: "json",
            data: {
                q: text,
                target: targetLang,
                key: apiKey
            },
            success: function (response) {
                var translatedText = response.data.translations[0].translatedText;
                korean.innerHTML = translatedText;
                //자동 전송 코드
                const messageInputDom = document.querySelector('#korean');
                const message = messageInputDom.textContent;
                VoicechatSocket.send(
                    JSON.stringify({
                        message: message,
                        user: username,
                        user_id: user_id,
                        command: 'new_message'
                    })
                );
                messageInputDom.textContent = '';
                const data = JSON.parse(e.data);
                //tts
                if (data['command'] === 'messages') {
                for (let i = 0; i < data['messages'].length; i++) {
                    createMessage(data['messages'][i]);
                    if (message.user != username){
                        const messageText = JSON.stringify(data['messages'][1]);
                        textToSpeech(messageText, 'ko'); // 메시지 도착 시 TTS 실행
                    }
                }
                } else if (data['command'] === 'new_message') {
                createMessage(data['message']);
                const message = data['message'];
                if (message.user != username){
                    const messageText = `${message.content}`;
                    textToSpeech(messageText, 'ko'); // 메시지 도착 시 TTS 실행
                }
                }
            },
            error: function (error) {
                console.log("Translation API error:", error);
            }
        });
        }

        function textToSpeech(txt, lang) {
        if ('speechSynthesis' in window) {
            var msg = new SpeechSynthesisUtterance();
            var voices = window.speechSynthesis.getVoices();
            // var selectedTranslationLanguage = translationLanguage.value;
            // var targetLang = selectedTranslationLanguage;
            var selectedLanguage = languageSelect.value;
            var targetLang = selectedLanguage;
            msg.voiceURI = 'native';
            msg.volume = 1; // 0 to 1
            msg.rate = 1.0; // 0.1 to 10
            msg.text = txt;
            if (targetLang === 'ko') {
            msg.lang = 'ko-KR'; // 한국어 (대한민국)
        } else if (targetLang === 'en-US') {
            msg.lang = 'en-US'; // 영어 (미국)
        } else if (targetLang === 'zh-CN') {
            msg.lang = 'zh-CN'; // 중국어 (간체)
        } else if (targetLang === 'ja-JP') {
            msg.lang = 'ja-JP'; // 일본어
        } else if (targetLang === 'vi-VN') {
            msg.lang = 'vi-VN'; // 베트남어 - 현재 지원 안함
        } else if (targetLang === 'th-TH') {
            msg.lang = 'th-TH'; // 태국어 - 현재 지원 안함
        }
            msg.onend = function (e) {
            if (isRecognizing == false) {
                startSTT();
            }
            console.log('Finished in ' + event.elapsedTime + ' seconds.');
            };

            if (targetLang === 'vi-VN') {
                tts_th_vi(msg.text, "vi-VN-HoaiMyNeural");
            }
            else if (targetLang === 'th-TH') {
                tts_th_vi(msg.text, "th-TH-PremwadeeNeural");
            }
            else {
                window.speechSynthesis.speak(msg);
            }
        }
        }

        // --------- tts --------- 
        function tts_th_vi(text, lang) {
            var SpeechSDK;
            var speech_key = document.querySelector('#tts-key').innerText;
            var speech_region = document.querySelector('#tts-region').innerText;

            if (!!window.SpeechSDK) {
                SpeechSDK = window.SpeechSDK;
                
                // in case we have a function for getting an authorization token, call it.
                if (typeof RequestAuthorizationToken === "function") {
                    RequestAuthorizationToken();
                }
            }
        
            // var sdk = require("microsoft-cognitiveservices-speech-sdk");

            const speechConfig = SpeechSDK.SpeechConfig.fromSubscription('612d765c764e4794be080931e3b768fb', 'koreacentral');
            const audioConfig = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
        
            speechConfig.speech_synthesis_voice_name = lang;   // 베트남어 : vi-VN-HoaiMyNeural 태국어 : th-TH-PremwadeeNeural
        
            var synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig, audioConfig);

            synthesizer.speak_Text_Async(
                text,
                function (result) {
                    window.console.log(result);
                    synthesizer.close();
                    synthesizer = undefined;
                    return result.audioData;
                },
                function (err) {
                    window.console.log(err);
                    synthesizer.close();
                    synthesizer = undefined;
                }
            );
        }

        // 채팅 템플렛 적용 코드
        function createMessage(data) {
            const author = data['user'];
            const content = data['content'];

            const chatLogDiv = document.querySelector('#chat-log');

            const chatLogDownDiv = document.createElement('div');
            chatLogDownDiv.classList.add('message');
            if (author === username) {
                chatLogDownDiv.classList.add('self');
            }
            chatLogDiv.appendChild(chatLogDownDiv);

            const chatLogDownDownDiv = document.createElement('div');
            chatLogDownDownDiv.classList.add('message-wrapper');
            chatLogDownDiv.appendChild(chatLogDownDownDiv);

            const chatLogDownDownDownDiv = document.createElement('div');
            chatLogDownDownDownDiv.classList.add('message-content');
            chatLogDownDownDownDiv.id = "chat-message-div";
            chatLogDownDownDiv.appendChild(chatLogDownDownDownDiv);

            const chatLogDownDownDownDownSpan = document.createElement('span');
            chatLogDownDownDownDownSpan.innerText = `${content} `;
            if (author === username) {
                chatLogDownDownDownDownSpan.id = 'selfmessage';
            }
            else {
                chatLogDownDownDownDownSpan.id = 'chatmessage';
            }
            chatLogDownDownDownDiv.appendChild(chatLogDownDownDownDownSpan);
            
            scrollToBottom();  
        }
    </script>
</body>

</html>